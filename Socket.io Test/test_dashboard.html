<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkSphere Chat - Socket.IO Test Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .log-container {
            height: 400px;
            overflow-y: scroll;
            background-color: #212529;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-time { color: #888; margin-right: 10px; }
        .log-type-emit { color: #00ccff; font-weight: bold; }
        .log-type-on { color: #ffcc00; font-weight: bold; }
        .log-type-error { color: #ff3333; font-weight: bold; }
        .card-header { font-weight: bold; }
    </style>
</head>
<body>

<div class="container-fluid p-4">
    <div class="row mb-3">
        <div class="col-12">
            <h2 class="text-primary text-center">üõ†Ô∏è LinkSphere Chat Debugger</h2>
        </div>
    </div>

    <div class="row">
        <!-- Left Panel: Controls -->
        <div class="col-md-5">
            
            <!-- Connection Card -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-dark text-white">1. Connection</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="serverUrl" class="form-label">Server URL</label>
                        <input type="text" class="form-control" id="serverUrl" value="http://localhost:3000">
                    </div>
                    <div class="mb-3">
                        <label for="authToken" class="form-label">JWT Token</label>
                        <textarea class="form-control" id="authToken" rows="3" placeholder="Paste Bearer Token here..."></textarea>
                    </div>
                    <button class="btn btn-primary w-100" id="btnConnect" onclick="connectSocket()">Connect</button>
                    <button class="btn btn-danger w-100 d-none" id="btnDisconnect" onclick="disconnectSocket()">Disconnect</button>
                    <div id="connectionStatus" class="mt-2 fw-bold text-center text-secondary">Not Connected</div>
                </div>
            </div>

            <!-- Send Message Card -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-success text-white">2. Send Message</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label">Target ID (User or Group)</label>
                        <input type="text" class="form-control" id="msgTargetId" placeholder="User ID or Chat ID">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Content</label>
                        <input type="text" class="form-control" id="msgContent" placeholder="Hello...">
                    </div>
                    <button class="btn btn-success w-100" onclick="emitSendMessage()">Emit 'send-message'</button>
                </div>
            </div>

            <!-- Other Events Card -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-info text-dark">3. Other Events</div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Recevier ID (Typing)</label>
                            <input type="text" class="form-control mb-2" id="typingReceiverId" placeholder="User ID">
                            <button class="btn btn-outline-primary w-100 btn-sm mb-1" onclick="emitStartWriting()">Start Writing</button>
                            <button class="btn btn-outline-secondary w-100 btn-sm" onclick="emitStopWriting()">Stop Writing</button>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Seen (Chat/Msg Is)</label>
                            <input type="text" class="form-control mb-1" id="seenChatId" placeholder="Chat ID">
                            <input type="text" class="form-control mb-2" id="seenMessageId" placeholder="Message ID">
                            <button class="btn btn-outline-warning w-100 btn-sm" onclick="emitMessageSeen()">Mark Seen</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Right Panel: Logs -->
        <div class="col-md-7">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <span>üìù Event Logs</span>
                    <button class="btn btn-sm btn-light" onclick="clearLogs()">Clear</button>
                </div>
                <div class="card-body p-0">
                    <div id="logContainer" class="log-container">
                        <div class="log-entry"><span class="log-time">System:</span> Ready to connect...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script>
    let socket;

    function log(message, type = 'info') {
        const container = document.getElementById('logContainer');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        const time = new Date().toLocaleTimeString();
        
        let typeHtml = '';
        if(type === 'emit') typeHtml = '<span class="log-type-emit">[EMIT]</span> ';
        if(type === 'on') typeHtml = '<span class="log-type-on">[RECV]</span> ';
        if(type === 'error') typeHtml = '<span class="log-type-error">[ERROR]</span> ';

        entry.innerHTML = `<span class="log-time">${time}</span> ${typeHtml}${message}`;
        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;
    }

    function clearLogs() {
        document.getElementById('logContainer').innerHTML = '';
    }

    function updateStatus(status, color) {
        const el = document.getElementById('connectionStatus');
        el.innerText = status;
        el.className = `mt-2 fw-bold text-center text-${color}`;
        
        if (status === 'Connected') {
            document.getElementById('btnConnect').classList.add('d-none');
            document.getElementById('btnDisconnect').classList.remove('d-none');
        } else {
            document.getElementById('btnConnect').classList.remove('d-none');
            document.getElementById('btnDisconnect').classList.add('d-none');
        }
    }

    function connectSocket() {
        const url = document.getElementById('serverUrl').value;
        const token = document.getElementById('authToken').value.trim();

        if (!token) {
            alert('Please enter a JWT Token');
            return;
        }

        // Format token if missing 'Bearer'
        const authValue = token.startsWith('Bearer ') ? token : `Bearer ${token}`;

        log(`Connecting to ${url}...`, 'info');

        socket = io(url, {
            auth: {
                authorization: authValue
            },
            transports: ['websocket']
        });

        // --- Connection Events ---
        socket.on('connect', () => {
            log(`Connected! Socket ID: ${socket.id}`, 'on');
            updateStatus('Connected', 'success');
        });

        socket.on('disconnect', (reason) => {
            log(`Disconnected: ${reason}`, 'error');
            updateStatus('Disconnected', 'danger');
        });

        socket.on('connect_error', (err) => {
            log(`Connection Error: ${err.message}`, 'error');
            updateStatus('Error', 'danger');
        });

        socket.on('custom_error', (err) => {
             log(`Server Error: ${JSON.stringify(err)}`, 'error');
        });

        // --- Chat Events Listeners ---

        socket.on('success-message', (data) => {
            log(`success-message: ${JSON.stringify(data, null, 2)}`, 'on');
        });

        socket.on('new-message', (data) => {
            log(`new-message: ${JSON.stringify(data, null, 2)}`, 'on');
        });

        socket.on('writing-start', (data) => {
            log(`writing-start: ${JSON.stringify(data, null, 2)}`, 'on');
        });

        socket.on('writing-stop', (data) => {
            log(`writing-stop: ${JSON.stringify(data, null, 2)}`, 'on');
        });

        socket.on('message-seen', (data) => {
            log(`message-seen: ${JSON.stringify(data, null, 2)}`, 'on');
        });
    }

    function disconnectSocket() {
        if (socket) {
            socket.disconnect();
            socket = null;
        }
    }

    // --- Emitters ---

    function emitSendMessage() {
        if(!socket || !socket.connected) return alert('Not connected!');
        
        const sendTo = document.getElementById('msgTargetId').value;
        const content = document.getElementById('msgContent').value;

        if(!sendTo || !content) return alert('Target ID and Content are required');

        const payload = { content, sendTo };
        
        log(`Sending: ${JSON.stringify(payload)}`, 'emit');
        socket.emit('send-message', payload);
    }

    function emitStartWriting() {
        if(!socket || !socket.connected) return alert('Not connected!');
        const receiverId = document.getElementById('typingReceiverId').value;
        if(!receiverId) return alert('Receiver ID required');

        const payload = { receiverId };
        log(`Start Writing: ${JSON.stringify(payload)}`, 'emit');
        socket.emit('writing-start', payload);
    }

    function emitStopWriting() {
        if(!socket || !socket.connected) return alert('Not connected!');
        const receiverId = document.getElementById('typingReceiverId').value;
        if(!receiverId) return alert('Receiver ID required');

        const payload = { receiverId };
        log(`Stop Writing: ${JSON.stringify(payload)}`, 'emit');
        socket.emit('writing-stop', payload);
    }

    function emitMessageSeen() {
        if(!socket || !socket.connected) return alert('Not connected!');
        const chatId = document.getElementById('seenChatId').value;
        const messageId = document.getElementById('seenMessageId').value;

        if(!chatId || !messageId) return alert('Chat ID and Message ID required');

        const payload = { chatId, messageId };
        log(`Marking Seen: ${JSON.stringify(payload)}`, 'emit');
        socket.emit('message-seen', payload);
    }

</script>

</body>
</html>
